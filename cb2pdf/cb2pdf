#!/usr/bin/env bash

VERSION='1.0.0'

_usage() {
	echo "USAGE: $(basename "$0") [-hv] [-d <dpi>] <input.cbr|input.cbz> [output.pdf]"
}

cb2pdf_main() {
	# export PS4='+ ${BASH_SOURCE}:${LINENO}:${FUNCNAME[0]}() '
	# set -x
	set -euo pipefail

	E_ARGS=16
	E_MISSING_FILE=17
	E_MISSING_APP=18
	E_UNSUPPORTED_EXT=19
	E_NO_IMAGES=20

	[ $# -eq 0 ] && _usage && return

	DPI="${CB2PDF_DPI:-300}"

	while getopts ":hd:v-:" opt; do
		case "$opt" in
		h)
			_usage
			return
			;;
		v)
			echo "$(basename "$0") $VERSION"
			return
			;;
		d)
			DPI="$OPTARG"
			;;
		-)
			case "$OPTARG" in
			help)
				_usage
				return
				;;
			version)
				echo "$(basename "$0") $VERSION"
				return
				;;
			*)
				_fatal $E_ARGS "Unknown option: --$OPTARG"
				;;
			esac
			;;
		:)
			_fatal $E_ARGS "Option requires an argument: -$OPTARG"
			;;
		\?)
			_fatal $E_ARGS "Unknown option: -$OPTARG"
			;;
		esac
	done

	shift "$((OPTIND - 1))"

	[ $# -lt 1 ] && _fatal $E_ARGS "Missing arguments."

	INPUT="$1"
	OUTPUT="${2:-${INPUT%.*}.pdf}"

	[ ! -f "$INPUT" ] && _fatal $E_MISSING_FILE "Missing or not a file: $INPUT"

	input_ext="$(echo "${INPUT##*.}" | tr '[:upper:]' '[:lower:]')"
	case "$input_ext" in
	cbz | cbr) ;;
	*) _fatal $E_UNSUPPORTED_EXT "Unsupported input extension: .$input_ext (expected .cbz or .cbr)" ;;
	esac

	_require 7z img2pdf

	TMP_DIR="$(mktemp -d)"
	trap _cleanup EXIT INT TERM

	7z x -bd -y -o"$TMP_DIR" "$INPUT" >/dev/null

	mapfile -d '' -t IMAGE_FILES < <(
		find "$TMP_DIR" -type f \
			\( -iname '*.jpg' -o -iname '*.jpeg' -o -iname '*.png' \) \
			-print0 | _sort_files
	)

	[ "${#IMAGE_FILES[@]}" -eq 0 ] && _fatal $E_NO_IMAGES "No image files found in archive."

	img2pdf -s "${DPI}dpi" -o "$OUTPUT" "${IMAGE_FILES[@]}"
	echo "Created $OUTPUT"
}

_cleanup() {
	if [ -n "${TMP_DIR:-}" ] && [ -d "$TMP_DIR" ]; then
		rm -rf "$TMP_DIR"
	fi
}

_fatal() {
	local exit_code=$1
	shift
	echo "FATAL: $*" >&2
	exit "$exit_code"
}

_require() {
	missing_bin=0

	for bin in "$@"; do
		if ! command -v "$bin" >/dev/null 2>&1; then
			missing_bin=1
			echo "Required: $bin" >&2
		fi
	done

	if [ $missing_bin -ne 0 ]; then
		_fatal "$E_MISSING_APP" "One or more executables or apps are missing."
	fi
}

_sort_files() {
	if sort -zV </dev/null >/dev/null 2>&1; then
		sort -zV
	elif sort -z </dev/null >/dev/null 2>&1; then
		sort -z
	else
		tr '\0' '\n' | sort | tr '\n' '\0'
	fi
}

cb2pdf_main "$@"
