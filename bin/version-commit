#!/usr/bin/env bash

_usage() {
	echo "USAGE: $(basename "$0") <script_dir> <major|minor|patch>"
}

version_commit_main() {
	export PS4='+ ${BASH_SOURCE}:${LINENO}:${FUNCNAME[0]}() '
	set -x
	set -euo pipefail

	E_ARGS=16
	E_MISSING_FILE=17
	E_NOT_CLEAN=18
	E_MISSING_APP=19

	[ $# -eq 0 ] && _usage && return
	[ $# -lt 2 ] && _fatal $E_ARGS "Missing arguments."

	SELF_SCRIPT="$(realpath "${BASH_SOURCE[0]}")"
	SELF_DIR="$(dirname "$SELF_SCRIPT")"
	PATH="$SELF_DIR:$PATH"

	SCRIPT_DIR="$1"
	[ ! -d "$SCRIPT_DIR" ] && _fatal $E_MISSING_FILE "Missing or not a directory: $SCRIPT_DIR"

	SCRIPT_NAME="$(basename "$SCRIPT_DIR")"
	SCRIPT_FILE="$SCRIPT_DIR/$SCRIPT_NAME"

	[ ! -f "$SCRIPT_FILE" ] && _fatal $E_MISSING_FILE "Missing or not a file: $SCRIPT_FILE"

	if ! git diff --quiet || ! git diff --cached --quiet; then
		_fatal $E_NOT_CLEAN "Git working directory is not clean. Please commit or stash changes before running this script." >&2
	fi

	TYPE="$2"
	case "$TYPE" in
	major | minor | patch) ;;
	*) _fatal $E_ARGS "Invalid version type: $TYPE. Must be one of: major, minor, patch." ;;
	esac

	_require version

	version "$TYPE" "$SCRIPT_FILE"

	INIT_PWD="$(pwd)"

	git add "$SCRIPT_FILE"

	# detect git repo root of file
	REPO_ROOT="$(git -C "$SCRIPT_DIR" rev-parse --show-toplevel)"
	cd "$REPO_ROOT" || _fatal $E_MISSING_FILE "Cannot change directory to git repo root: $REPO_ROOT"

	git commit -m "Bump $SCRIPT_NAME to v$NEW_VERSION"
	git tag -a "$SCRIPT_NAME@$NEW_VERSION" -m "$SCRIPT_NAME v$NEW_VERSION"

	git archive \
		--format tar.gz \
		--prefix "$SCRIPT_NAME@$NEW_VERSION/" \
		-o "$SCRIPT_NAME@$NEW_VERSION.tar.gz" \
		"$SCRIPT_NAME@$NEW_VERSION:$SCRIPT_NAME/" \
		;

	sha256sum "$SCRIPT_NAME@$NEW_VERSION.tar.gz" >"$SCRIPT_NAME@$NEW_VERSION.tar.gz.sha256"
}

_fatal() {
	local exit_code=$1
	shift
	echo "FATAL: $*" >&2
	exit "$exit_code"
}

_require() {
	missing_bin=0

	for bin in "$@"; do
		if ! which "$bin" >/dev/null 2>&1; then
			missing_bin=1
			_error "Required: $bin"
		fi
	done

	if [ $missing_bin -ne 0 ]; then
		_fatal "$E_MISSING_APP" "One or more executables or apps are missing."
	fi
}

version_commit_main "$@"
